variables:
  PROJECT_PATH: "src/HolMirDas/HolMirDas.csproj"
  PACKAGE_REGISTRY_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/holmirdas/${CI_COMMIT_TAG}"

stages:          # List of stages for jobs, and their order of execution
  - build
  - publish
  - upload
  - release

build-job:       # This job runs in the build stage, which runs first.
  stage: build
  script:
    - dotnet restore $PROJECT_PATH
    - dotnet build  --no-restore $PROJECT_PATH
  tags:
    - net8

publish-windows:
  stage: publish
  script:
    - dotnet publish -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true -o ./publish-windows $PROJECT_PATH
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - $CI_PROJECT_DIR/publish-windows
  tags:
    - net8

publish-linux:
  stage: publish
  script:
    - dotnet publish -c Release -r linux-x64 --self-contained true /p:PublishSingleFile=true -o ./publish-linux $PROJECT_PATH
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - $CI_PROJECT_DIR/publish-linux
  tags:
    - net8

upload-to-registry:
  stage: upload
  script:
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file $CI_PROJECT_DIR/publish-windows/HolMirDas.exe \
           "${PACKAGE_REGISTRY_URL}/HolMirDas-win-x64.exe"
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file $CI_PROJECT_DIR/publish-linux/HolMirDas \
           "${PACKAGE_REGISTRY_URL}/HolMirDas-linux-x64"
  only:
    - tags
  dependencies:
    - publish-windows
    - publish-linux
  tags:
    - net8

release-job:
  stage: release
  script:
    - echo "Creating release for tag $CI_COMMIT_TAG"
    - command -v glab
    - echo "Checked for glab"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: "HolMirDas $CI_COMMIT_TAG"
    assets:
      links:
        - name: "Windows Binary"
          url: "${PACKAGE_REGISTRY_URL}/HolMirDas-win-x64.exe"
          link_type: other
        - name: "Linux Binary"
          url: "${PACKAGE_REGISTRY_URL}/HolMirDas-linux-x64"
          link_type: other
  only:
    - tags
  dependencies:
    - upload-to-registry
  tags:
    - net8
